{% extends 'base.html' %}
{% block title %}Settings{% endblock %}
{% block custom_scripts %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<style>
        /* Some basic CSS styles for the template */
        p {
                margin: 0px;
        }
        h1 {
            color: #333;
        }
        .journal-entry {
            background-color: #cde8cd;
            margin-bottom: 5px;
            transition: background-color 0.5s ease-in-out;
        }
        .journal-entry.fadeout {
            background-color: transparent;
            transition: background-color 5s ease-in-out;
        }
	.disableddiv {
    	    pointer-events: none;
    	    opacity: 0.4;
	}
	.form-switch-lg >input {
		width: 50px !important;
		height: 30px !important;
	}
    
    /* Make the System date & time field fit the same width as other fields */
.system-datetime-input{
    text-align: center !important;
font-size: 0.75rem;
  padding-left: .25rem;
  padding-right: .25rem;
  font-family: Inter, Roboto, ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
}


/* Settings: etykiety w list-group bez pogrubienia */
#settingsForm .list-group-item strong.mb-0{
  font-weight: 400; /* 400 = normal, 500 = lekko grubsze */
}

/* List-group: utrzymaj zaokrąglone rogi także gdy elementy są zagnieżdżone */
#settingsForm .list-group{ overflow: hidden; }

/* Zachowaj zaokrąglenia list-group gdy używamy wrappera do show/hide */
#dhw_settings{ display: contents; }

/* HPI App: zmniejsz "Disconnected/Connected" do rozmiaru jak "Unknown" */
#hpistatus{
  font-size: 1rem !important;   /* jak normalny tekst */
  font-weight: 400 !important;  /* bez mocnego pogrubienia */
  margin: 0 !important;         /* h3 ma domyślnie marginesy */
  line-height: 1.2;
}

/* ===== Mobile UX for Settings ===== */
@media (max-width: 576px){
  /* Zakładki w jednej linii, przewijane poziomo */
  #settings{
    flex-wrap: nowrap !important;
    overflow-x: auto !important;
    overflow-y: hidden !important;
    -webkit-overflow-scrolling: touch;
    gap: .25rem;
    padding-bottom: .25rem;
  }
  #settings::-webkit-scrollbar{ display:none; }
  #settings .nav-link{
    white-space: nowrap;
    padding: .45rem .6rem;
    font-size: .95rem;
  }

  /* Trochę ciaśniej w kartach/wierszach */
  #settingsForm .list-group-item{ padding: .70rem .75rem; }
  #settingsForm .form-control,
  #settingsForm .form-select{
    padding-top: .45rem;
    padding-bottom: .45rem;
  }

  /* Zapisz (mobile): w normalnym flow, tuż pod ostatnim polem.
     To usuwa duży "pusty" odstęp w zakładkach z małą liczbą ustawień. */
  #saveRow{
    position: static !important;
    z-index: 1;
    margin-top: .75rem;
    margin-bottom: .5rem !important;
    padding: 0;
    background: transparent;
    border-top: 0;
  }
  #saveRow .btn{
    padding: .85rem 1rem;
    font-size: 1.1rem;
    border-radius: .75rem;
  }

  /* Odetnij zbędne marginesy na końcu zakładek (żeby nie było pustego przewijania) */
  #ex1-content .tab-pane .list-group:last-of-type{ margin-bottom: .5rem !important; }

  /* Defensive: unikaj wymuszonych wysokości (czasem robią pusty scroll) */
  .tab-content, .tab-pane{ height: auto !important; min-height: 0 !important; }
}

</style>
{% endblock %}
{% block page_body %}
<div class="modal fade" id="unsavedChangesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Niezapisane zmiany</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Masz niezapisane zmiany. Czy na pewno chcesz opuścić stronę?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Zostań</button>
                <button type="button" class="btn btn-outline-danger" id="leavePageBtn">Opuść stronę</button>
            </div>
        </div>
    </div>
</div>
<div class="row justify-content-center">
    <div class="col-12 col-lg-10 col-xl-8 mx-auto">
	    
        <div class="my-3">
            <!-- Tabs navs -->
            <ul class="nav nav-underline mb-3" id="settings" role="tablist">
                <li class="nav-item" role="presentation">
			<a class="nav-link active" id="settings-general" data-bs-toggle="tab" data-bs-target="#settings-general-tab" role="tab" aria-controls="settings-general-tab" aria-selected="true" href="#settings-general-tab" data-i18n="set.general">General</a>
                </li>
                <li class="nav-item" role="presentation">
			<a class="nav-link" id="settings-hcurve" data-bs-toggle="tab" data-bs-target="#settings-hcurve-tab" role="tab" aria-controls="settings-hcurve-tab" aria-selected="true" href="#settings-hcurve-tab" data-i18n="set.coolheat">Heating/Cooling</a>
                </li>
                <li class="nav-item" role="presentation">
			<a class="nav-link" id="settings-dhwcontrol" data-bs-toggle="tab" data-bs-target="#settings-dhwcontrol-tab" role="tab" aria-controls="settings-dhwcontrol-tab" aria-selected="false" href="#settings-dhwcontrol-tab" data-i18n="set.dhwcontrol">Sterowanie CWU</a>
			</li>
                <li class="nav-item" role="presentation">
			<a class="nav-link" id="settings-ha" data-bs-toggle="tab" data-bs-target="#settings-ha-tab" role="tab" aria-controls="settings-ha-tab" aria-selected="false" href="#settings-ha-tab" data-i18n="set.homeassistant">Home Assistant</a>
                </li>
                <li class="nav-item" role="presentation">
			<a class="nav-link" id="settings-mqtt" data-bs-toggle="tab" data-bs-target="#settings-mqtt-tab" role="tab" aria-controls="settings-mqtt-tab" aria-selected="false" href="#settings-mqtt-tab" data-i18n="set.mqtt">MQTT</a>
                </li>
		<li class="nav-item" role="presentation">
                        <a class="nav-link" id="settings-hpiapp" data-bs-toggle="tab" data-bs-target="#settings-hpiapp-tab" role="tab" aria-controls="settings-hpiapp-tab" aria-selected="false" href="#settings-hpiapp-tab" data-i18n="set.hpiapp">Aplikacja HPi</a>
                </li>
                <li class="nav-item" role="presentation">
			<a class="nav-link" id="settings-system" data-bs-toggle="tab" data-bs-target="#settings-system-tab" role="tab" aria-controls="settings-system-tab" aria-selected="false" href="#settings-system-tab" data-i18n="set.system">System</a>
                </li>

            
                <li class="nav-item" role="presentation">
			<a class="nav-link" id="settings-service" data-bs-toggle="tab" data-bs-target="#settings-service-tab" role="tab" aria-controls="settings-service-tab" aria-selected="false" href="#settings-service-tab" data-i18n="set.service">Service</a>
                </li>
</ul>
            <!-- Tabs navs -->

            <!-- Tabs content -->
	<form id="settingsForm" method="POST" onsubmit="return false;">
            <div class="tab-content" id="ex1-content">
                <div class="tab-pane fade show active" id="settings-general-tab" role="tabpanel" aria-labelledby="settings-general-tab">
                    
                    <!-- Grouped: General settings -->

<!-- Slightly smaller gap before error box (match other tabs) -->
<div class="list-group mb-4 shadow">

                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col">
					    <strong class="mb-0" data-i18n="set.intempsensor">Czujnik temperatury wewnętrznej</strong>
					    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.intempsensortooltip" data-bs-title="Wybierz jakiego czujnika temperatury używasz ? (<i>'HA'</i> - dla encji z Home Assistant, <i>'Wbudowany'</i> - fizycznie podłączony sensor DHT22"></i>

</div>
                            <div class="col-md-2">
                                <div class="custom-control custom-switch">
                                    <select class="form-select" aria-label="insidetemp" name="SETTINGS$insidetemp" value="">
					    <option data-i18n="ha" value="ha">HA</option>
					    <option data-i18n="builtin" value="builtin">Builtin</option>
                                    </select>
                                    <span class="custom-control-label"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col">
	                                <strong class="mb-0" data-i18n="set.emergency_intemp">Emergency inside temp</strong>
	                                <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true"
	                                   data-i18n="[data-bs-title]set.emergency_intemp_tooltip"
	                                   data-bs-title="When there is no inside temperature reading from sensors / Home Assistant (e.g. after reboot or failure), the system will use this value to keep heating."></i>
                            </div>
                            <div class="col-md-2">
                                <input type="number" class="form-control" name="SETTINGS$emergency_intemp" step="0.1" min="5" max="35" value="">
                            </div>
                        </div>
                    </div>
					<div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col">
				    <strong class="mb-0" data-i18n="set.huminsensor">huminsensor</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.humintooltip" data-bs-title="."></i>
                            </div>
                            <div class="col-md-2">
                                <div class="custom-control custom-switch">
                                    <select class="form-select" aria-label="humidity" name="SETTINGS$humidity" value="">
					    <option data-i18n="ha" value="ha">HA</option>
					    <option data-i18n="builtin" value="builtin">Builtin</option>
                                    </select>
                                    <span class="custom-control-label"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col">
				    <strong class="mb-0" data-i18n="set.outtempsensor">Czujnik temperatury zewnętrznej</strong>
				                                                <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.outtempsensortooltip" data-bs-title="What temperature sensor you using (ha - for home assistant entity, builtin - for physically connect DS18b20 sensor, Tao - for built-in pump ambient sensor, Open Meteo - for online weather service ( you need to provide the coordinates of your town )"></i>

                            </div>
                            <div class="col-md-2">
                                <div class="custom-control custom-switch">
                                    <select id="outsidetemp" class="form-select" aria-label="outsidetemp" name="SETTINGS$outsidetemp" value="">
					    <option data-i18n="ha" value="ha">HA</option>
					<option data-i18n="builtin" value="builtin">Builtin</option>
                                            <option data-i18n="tao" value="tao">Tao</option>
                                    </select>
                                    <span class="custom-control-label"></span>
                                </div>
                            </div>
                        </div>
                    </div>
		                        </div>



                </div>
                
                <div class="tab-pane fade" id="settings-dhwcontrol-tab" role="tabpanel" aria-labelledby="settings-dhwcontrol-tab">

                    <div class="list-group mb-4 shadow">
                        <div class="list-group-item">
                            <div class="row align-items-center">
                                <div class="col">
                                    <strong class="mb-0" data-i18n="set.dhwtempsensor">DHW temperature sensor</strong>
                                    <i class="bi bi-info-circle ms-2 text-accent3"
                                       data-bs-toggle="tooltip" data-bs-placement="bottom"
                                       data-bs-html="true"
                                       data-i18n="[data-bs-title]set.dhwtempsensortooltip"
                                       data-bs-title="Choose the DHW temperature source: built-in sensor or Home Assistant entity"></i>
                                </div>
                                <div class="col-md-2">
                                    <div class="custom-control custom-switch">
                                        <select class="form-select" name="SETTINGS$dhwtemp">
                                            <option data-i18n="builtin" value="builtin" {% if dhwtemp == "builtin" %}selected{% endif %}>Builtin</option>
                                            <option data-i18n="ha" value="ha" {% if dhwtemp == "ha" %}selected{% endif %}>HA</option>
                                        </select>
                                        <span class="custom-control-label"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                <div class="list-group mb-4 shadow">
                                <div class="list-group-item">
                                        <div class="row align-items-center">
                			    <div class="col">
                				    <strong class="mb-0" data-i18n="set.dhwuse">set.dhwuse</strong>
                				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true" data-i18n="[data-bs-title]set.dhwusetooltip" data-bs-title="."></i>
                			    </div>
                                            <div class="col-md-2">
                                                <div class="custom-control custom-switch form-switch form-switch-lg text-center">
                                                        <input type="hidden" id="dhwuse_hidden" value="" name="SETTINGS$dhwuse">
                                                          <input type="checkbox" class="form-check-input" id="dhwuse" value="1" aria-describedby="dhwuse">
                                                    <span class="custom-control-label"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="dhw_settings">
                                    <div class="list-group-item">
                                        <div class="row align-items-center">
                                            <div class="col">
                				    <strong class="mb-0" data-i18n="set.dhwnolimit"></strong>
                				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.dhwnolimittooltip" data-bs-title="."></i>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="custom-control custom-switch form-switch form-switch-lg text-center">
                                                        <input type="hidden" id="dhwwl_hidden" value="" name="SETTINGS$dhwwl">
                                                          <input type="checkbox" class="form-check-input" id="dhwwl" value="1" aria-describedby="dhwwl">
                                                    <span class="custom-control-label"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="dhw_mode_settings" class="mt-3">
                                            <div class="row align-items-center mb-2">
                                                <div class="col">
                                                    <strong class="mb-0" data-i18n="set.dhwnolimit_mode">{{ _('Tryb pracy dhw') }}</strong>
                                                	<i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.dhwnolimit_modetooltip" data-bs-title="."></i>
                                                </div>
                                                <div class="col-md-2">
                                                    <select class="form-select" aria-label="dhwnolimit_mode" id="dhwnolimit_mode" name="SETTINGS$dhwnolimit_mode" value="">
                                                        <option value="turbo">Turbo</option>
                                                        <option value="eco">Eco</option>
                                                        <option value="quiet">Quiet</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="list-group-item">
                                        <div class="row align-items-center">
                                            <div class="col">
                				    <strong class="mb-0" data-i18n="set.dhwscheduler">{{ _('Używaj harmonogramu dla C.W.U') }}</strong>
                				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.dhwschedulertooltip" data-bs-title="."></i>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="custom-control custom-switch form-switch form-switch-lg text-center">
                                                        <input type="hidden" id="dhwscheduler_hidden" value="" name="SETTINGS$dhwscheduler">
                                                          <input type="checkbox" class="form-check-input" id="dhwscheduler" value="1" aria-describedby="dhwscheduler" >
                                                    <span class="custom-control-label"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    </div>
                </div>
                </div>

<div class="tab-pane fade" id="settings-hcurve-tab" role="tabpanel" aria-labelledby="settings-hcurve-tab">

                    <div class="list-group mb-4 shadow">



                        <div class="list-group-item">


                            <div class="row align-items-center">


                                <div class="col">


                                    <strong class="mb-0" data-i18n="set.heatcontrol">{{ _('Sterowanie ogrzewaniem') }}</strong>


                                    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true" data-i18n="[data-bs-title]set.heatcontroltooltip" data-bs-title="."></i>


                                </div>


                                <div class="col-md-2">


                                    <div class="custom-control custom-switch">


                                        <select class="form-select" aria-label="heatingcontrol" id="heatingcontrol">


                                            <option value="curve" data-i18n="set.heatcontrol.curve" {% if heatingcurve != 'directly' %}selected{% endif %}>{{ _('Krzywa grzewcza') }}</option>


                                            <option value="direct" data-i18n="set.heatcontrol.direct" {% if heatingcurve == 'directly' %}selected{% endif %}>{{ _('Bezpośrednio') }}</option>


                                        </select>


                                        <span class="custom-control-label"></span>


                                    </div>


                                </div>


                            </div>


                        </div>



                    </div>



                    <div id="heatingcurve_section" class="list-group mb-4 shadow {% if heatingcurve == 'directly' %}disableddiv{% endif %}">

                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col">
				    <strong class="mb-0" data-i18n="set.hctype">{{ _('Typ krzywej grzewczej') }}</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.hctypetooltip" data-bs-title="."></i>
                            </div>
                            <div class="col-md-2">
				    <div class="custom-control custom-switch">
                                    <input type="hidden" id="heatingcurve_hidden" name="SETTINGS$heatingcurve" value="{{ heatingcurve }}">
                                    <select class="form-select" aria-label="heatingcurve" id="heatingcurve" value="">
					    <option value="auto" data-i18n="auto" >{{ _('Automatyczna') }}</option>
					    <option value="static" data-i18n="static" >{{ _('Statyczna') }}</option>
					    <option value="manual" data-i18n="manual" >{{ _('Ręczna') }}</option>
					    
                                    </select>
                                    <span class="custom-control-label"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col">
				    <strong class="mb-0" data-i18n="set.hctime">{{ _('Częstotliwość obliczania krzywej grzewczej w minutach') }}</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.hctimetooltip" data-bs-title="."></i>
                            </div>
                            <div class="col-md-2">
                                <div class="custom-control custom-switch">
                                    <input type="number" class="form-control" id="timeout" name="MAIN$heizfreq" aria-describedby="timeout" value="">
                                    <span class="custom-control-label"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="divslope" class="list-group-item {% if heatingcurve == "auto" or
			    			      heatingcurve == "static" %}
							NONE
						      {% else %}
						      disableddiv
						      {% endif %}">
                        <div class="row align-items-center">
                            <div class="col">
				    <strong class="mb-0" data-i18n="set.hcslope">{{ _('Nachylenie krzywej grzeczej') }}</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.hcslopetooltip" data-bs-title="."></i>
                            </div>
                            <div class="col-md-2">
                                <div class="custom-control custom-switch">
                                    <input type="number" class="form-control" id="slope" name="SETTINGS$hcslope" aria-describedby="slope" step="0.01" onchange="recalc()" value="">
                                    <span class="custom-control-label"></span>
                                </div>
                            </div>
                        </div>
                    </div>
		    <div id="divpshift" class="list-group-item {% if heatingcurve != 'auto' %} disableddiv {% endif %}">
                        <div class="row align-items-center">
                            <div class="col">
				    <strong class="mb-0" data-i18n="set.hcpshift">{{ _('Przesunięcie równoległe krzywej grzewczej') }}</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.hcpshifttooltip" data-bs-title="."></i>
                            </div>
                            <div class="col-md-2">
                                <div class="custom-control custom-switch">
                                    <input type="number" class="form-control" id="pshift" name="SETTINGS$hcpshift" aria-describedby="pshift" step="0.1" onchange="recalc()" value="">
                                    <span class="custom-control-label"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="divhcamp" class="list-group-item {% if heatingcurve != 'auto' %} disableddiv {% endif %}">
                        <div class="row align-items-center">
                            <div class="col">
				    <strong class="mb-0" data-i18n="set.hcamp">{{ _('Wzmocnienie krzywej grzewczej') }}</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.hcamptooltip" data-bs-title="."></i>
                            </div>
                            <div class="col-md-2">
                                <div class="custom-control custom-switch">
                                    <input type="number" class="form-control" id="hcamp" name="SETTINGS$hcamp" aria-describedby="hcamp" step="0.1" onchange="recalc()" value="">
                                    <span class="custom-control-label"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="divhcmanual" class="list-group-item {% if heatingcurve != 'manual' %} disableddiv {% endif %}">
                        <div class="row align-items-center">
                            <div class="col">
                                    <strong class="mb-0" data-i18n="set.hcman">{{ _('Zadana temperatura C.O dla ręcznej krzywej:') }}</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.hcmantooltip" data-bs-title="."></i>
				    <p class="mb-0"><table class="table" id="hcmantable">
  <thead>
    <tr>
      <th scope="col">-20</th>
      <th scope="col">-15</th>
      <th scope="col">-10</th>
      <th scope="col">-8</th>
      <th scope="col">-6</th>
      <th scope="col">-4</th>
      <th scope="col">-2</th>
    </tr>
  </thead>
  <tbody class="table-group-divider">
    <tr>
      <td class="p-0 p-md-2"><input type="number" class="form-control" id="hcmn20" aria-describedby="hcmn20" step="0.5" onchange="manual_hcurve()" value=""></td>
      <td class="p-0 p-md-2"><input type="number" class="form-control" id="hcmn15" aria-describedby="hcmn15" step="0.5" onchange="manual_hcurve()" value=""></td>
      <td class="p-0 p-md-2"><input type="number" class="form-control" id="hcmn10" aria-describedby="hcmn10" step="0.5" onchange="manual_hcurve()" value=""></td>
      <td class="p-0 p-md-2"><input type="number" class="form-control" id="hcmn8" aria-describedby="hcmn8" step="0.5" onchange="manual_hcurve()" value=""></td>
      <td class="p-0 p-md-2"><input type="number" class="form-control" id="hcmn6"  aria-describedby="hcmn6" step="0.5" onchange="manual_hcurve()" value=""></td>
      <td class="p-0 p-md-2"><input type="number" class="form-control" id="hcmn4" aria-describedby="hcmn4" step="0.5" onchange="manual_hcurve()" value=""></td>
      <td class="p-0 p-md-2"><input type="number" class="form-control" id="hcmn2" aria-describedby="hcmn2" step="0.5" onchange="manual_hcurve()" value=""></td>
    </tr>
<thead>
	<tr>
		<th scope="col">0</th>
		<th scope="col">2</th>
		<th scope="col">4</th>
		<th scope="col">6</th>
		<th scope="col">8</th>
		<th scope="col">10</th>
		<th scope="col">15</th>
	</tr>
</thead>
<tbody class="table-group-divider">
    <tr>
		<td class="p-0 p-md-2"><input type="number" class="form-control" id="hcm0" aria-describedby="hcm0" step="0.5" onchange="manual_hcurve()" value=""></td>
		<td class="p-0 p-md-2"><input type="number" class="form-control" id="hcmp2" aria-describedby="hcmp2" step="0.5" onchange="manual_hcurve()" value=""></td>
		<td class="p-0 p-md-2"><input type="number" class="form-control" id="hcmp4" aria-describedby="hcmp4" step="0.5" onchange="manual_hcurve()" value=""></td>
		<td class="p-0 p-md-2"><input type="number" class="form-control" id="hcmp6" aria-describedby="hcmp6" step="0.5" onchange="manual_hcurve()" value=""></td>
		<td class="p-0 p-md-2"><input type="number" class="form-control" id="hcmp8"  aria-describedby="hcmp8" step="0.5" onchange="manual_hcurve()" value=""></td>
		<td class="p-0 p-md-2"><input type="number" class="form-control" id="hcmp10" aria-describedby="hcmp10" step="0.5" onchange="manual_hcurve()" value=""></td>
		<td class="p-0 p-md-2"><input type="number" class="form-control" id="hcmp15" aria-describedby="hcmp15" step="0.5" onchange="manual_hcurve()" value=""></td>
    </tr>
    <input type="hidden" class="form-control" value="" id="hcman" name="SETTINGS$hcman" aria-describedby="hcman">
  </tbody>
</table></p>
                            </div>
                        </div>
                    </div>
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col">
				    <strong class="mb-0" data-i18n="set.hcchart">{{ _('Wykres krzywej grzewczej') }}</strong>
                                </div>
                            <div class="col-md-2">
				    <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#chartdiv" data-i18n="show" aria-expanded="false" aria-controls="chartdiv">{{ _('Show') }}</button>
                                 </div>
                        <div id="chartdiv" class="collapse">
				<p><label for="tempRange" id="customtemp" data-i18n="set.intemp" class="form-label">{{ _('Temperatura wewnątrz: 21') }}</label></p>
				<i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.intemptooltip" data-bs-title="."></i>
				
				<input type="range" class="form-range" min="12" max="30" id="tempRange" onchange="recalc();">
                                <canvas id="hcurvechart"></canvas>

                            </div>
                        </div>
                    </div>
		    <!--<button type="submit" class="btn btn-primary" data-i18n="set.btn.save">{{ _('Zapisz ustawienia') }}</button>-->
                    </div>

<!-- Direct mode: thermostat gating + inside setpoint -->
<div id="directmode_section" class="list-group mb-4 shadow {% if heatingcurve != 'directly' %}disableddiv{% endif %}">
    <div class="list-group-item">
        <div class="row align-items-center">
            <div class="col">
                <strong class="mb-0" data-i18n="set.directthermostat">{{ _('Termostat w trybie bezpośrednim') }}</strong>
                <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true" data-i18n="[data-bs-title]set.directthermostattooltip" data-bs-title="."></i>
            </div>
            <div class="col-md-2">
                <div class="custom-control custom-switch form-switch form-switch-lg text-center">
                    <input type="hidden" id="direct_thermostat_hidden" value="" name="SETTINGS$direct_thermostat">
                    <input type="checkbox" class="form-check-input" id="direct_thermostat" aria-describedby="direct_thermostat">
                    <span class="custom-control-label"></span>
                </div>
            </div>
        </div>
    </div>
    <div class="list-group-item">
        <div class="row align-items-center">
            <div class="col">
                <strong class="mb-0" data-i18n="set.directinsidesettemp">{{ _('Zadana temperatura wewnątrz w trybie bezpośrednim') }}</strong>
                <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true" data-i18n="[data-bs-title]set.directinsidesettemptooltip" data-bs-title="."></i>
            </div>
            <div class="col-md-2">
                <div class="custom-control custom-switch">
                    <input type="number" class="form-control" id="direct_inside_settemp" name="SETTINGS$direct_inside_settemp" aria-describedby="direct_inside_settemp" step="0.5" value="">
                    <span class="custom-control-label"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="list-group mb-4 shadow">
		    <div class="list-group-item">
    <div class="row align-items-center">
        <div class="col">
				    <strong class="mb-0" data-i18n="set.freqlimit">{{ _('Ograniczenie częstotliwości') }}</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.freqlimittooltip" data-bs-title="."></i>
        </div>
        <div class="col-md-2">
				    <div class="custom-control custom-switch">
						    <select class="form-select" aria-label="flimit" name="SETTINGS$flimit" value="">
							    <option value="auto" data-i18n="auto" >{{ _('Automatyczne') }}</option>
							    <option value="manual" data-i18n="manual" >{{ _('Ręczne') }}</option>

                </select>
                <span class="custom-control-label"></span>
            </div>
        </div>
    </div>
</div>
		    <div class="list-group-item {% if antionoff == "1" %}disableddiv{% endif %}" id="divflimittemp">
     <div class="row align-items-center">
         <div class="col">
<strong class="mb-0" data-i18n="set.freqlimittemp">{{ _('Temperatura ograniczenia częstotliwości') }}</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.freqlimittooltip" data-bs-title="."></i>
        </div>
        <div class="col-md-2">
            <div class="custom-control custom-switch">
					<input type="number" class="form-control" id="flimittemp" name="SETTINGS$flimittemp" aria-describedby="flimittemp" value="">
                <span class="custom-control-label"></span>
            </div>
        </div>
    </div>
</div>
		    <div class="list-group-item {% if antionoff == "1" %}
			    disableddiv
			    {% endif %}" id="divpresetchange">
    <div class="row align-items-center">
        <div class="col">
				    <strong class="mb-0" data-i18n="set.presetchange">{{ _('Zmiana trybu') }}</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.presetchangetooltip" data-bs-title="."></i>
        </div>
        <div class="col-md-2">
				    <div class="custom-control custom-switch">
						    <select class="form-select" aria-label="presetautochange" name="SETTINGS$presetautochange" value="">
							    <option value="auto" data-i18n="auto" >{{ _('Automatyczna') }}</option>
							    <option value="manual" data-i18n="manual" >{{ _('Ręczna') }}</option>

                </select>
                <span class="custom-control-label"></span>
            </div>
        </div>
    </div>
</div>
		    <div class="list-group-item {% if antionoff == "1" %}disableddiv{% endif %}" id="divpresetquiet">
     <div class="row align-items-center">
        <div class="col">
<strong class="mb-0" data-i18n="set.quiettemp">{{ _('Temperatura trybu Quiet') }}</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.quiettemptooltip" data-bs-title="."></i>
        </div>
        <div class="col-md-2">
            <div class="custom-control custom-switch">
                    <input type="number" class="form-control" id="presetquiet" name="SETTINGS$presetquiet" aria-describedby="presetquiet" value="">
                <span class="custom-control-label"></span>
            </div>
        </div>
    </div>
</div>
		    <div class="list-group-item {% if antionoff == "1" %}disableddiv{% endif %}" id="divpresetturbo">
    <div class="row align-items-center">
        <div class="col">
<strong class="mb-0" data-i18n="set.turbotemp">{{ _('Temperatura trybu Turbo') }}</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.turbotemptooltip" data-bs-title="."></i>
        </div>
        <div class="col-md-2">
            <div class="custom-control custom-switch">
                    <input type="number" class="form-control" id="presetturbo" name="SETTINGS$presetturbo" aria-describedby="presetturbo" value="">
                <span class="custom-control-label"></span>
            </div>
        </div>
    </div>
</div>
</div>

<div class="list-group mb-4 shadow">
<div class="list-group-item {% if presetautochange == "manual"%}
			    				disableddiv
							{% endif %}">
                        <div class="row align-items-center">
                            <div class="col">
				    <strong class="mb-0" data-i18n="set.aooddelta">{{ _('Anty ON-OFF "<i>Delta</i>"') }}</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.aoodtooltip" data-bs-title="."></i>
                            </div>
                            <div class="col-md-2">
                                <div class="custom-control custom-switch form-switch form-switch-lg text-center">
					<input type="hidden" id="antionoff_hidden" value="" name="SETTINGS$antionoff">
                                    	<input type="checkbox" class="form-check-input" id="antionoff"aria-describedby="antionoff">
                                    <span class="custom-control-label"></span>
                                </div>
                            </div>
                        </div>
						
                    </div>
                    <div id="antionoffsettings" class="list-group-item {% if antionoff != "1" %}
                                                        disableddiv
                                                      {% endif %}">
                        <div class="row align-items-center">
                            <div class="col">
				    <strong class="mb-0" data-i18n="set.aoodt">{{ _('Czas przeliczania <i>Delty</i>') }}</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.aoodttooltip" data-bs-title="."></i>
                            </div>
                            <div class="col-md-2">
                                <div class="custom-control custom-switch">
                                    <input type="number" class="form-control" id="antionoffdeltatime" name="SETTINGS$antionoffdeltatime" aria-describedby="antionoffdeltatime" step="0.5" onchange="recalc()" value="">
                                    <span class="custom-control-label"></span>
                                </div>
                            </div>
                        </div>
						<div class="row align-items-center">
                            <div class="col">
				    <strong class="mb-0" data-i18n="set.aoodtdv">{{ _('Wartość <i>Delty</i> dla trybu Turbo') }}</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.aoodtdvtooltip" data-bs-title="."></i>
                            </div>
                            <div class="col-md-2">
                                <div class="custom-control custom-switch">
                                        <input type="number" class="form-control" id="deltatempturbo" name="SETTINGS$deltatempturbo" aria-describedby="deltatempturbo" step="0.1" onchange="recalc()" value="">
                                    <span class="custom-control-label"></span>
                                </div>
                            </div>
                        </div>
						<div class="row align-items-center">
                            <div class="col">
				    <strong class="mb-0" data-i18n="set.aoodqdv">{{ _('Wartość <i>Delty</i> dla trybu Quiet') }}</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.aoodqdvtooltip" data-bs-title="."></i>
                            </div>
                            <div class="col-md-2">
                                <div class="custom-control custom-switch">
                                        <input type="number" class="form-control" id="deltatempquiet" name="SETTINGS$deltatempquiet" aria-describedby="deltatempquiet" step="0.1" onchange="recalc()" value="">
                                    <span class="custom-control-label"></span>
                                </div>
                            </div>
                        </div>
						<div class="row align-items-center">
                            <div class="col">
				    <strong class="mb-0" data-i18n="set.aoodflv">{{ _('Wartość <i>Delty</i> dla Ograniczenia częstotliwości') }}</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.aoodflvtooltip" data-bs-title="."></i>
                            </div>
                            <div class="col-md-2">
                                <div class="custom-control custom-switch">
                                        <input type="number" class="form-control" id="deltatempflimit" name="SETTINGS$deltatempflimit" aria-describedby="deltatempflimit" step="0.1" onchange="recalc()" value="">
                                    <span class="custom-control-label"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                                        </div>

<div class="list-group mb-4 shadow">
<!-- Temperature Zones (Frost / Warm) -->
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col">
                                <strong class="mb-0" data-i18n="set.zone_frost">{{ _('Strefa mrozu') }}</strong>
                                <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true" data-i18n="[data-bs-title]set.zone_frosttooltip" data-bs-title="."></i></div>
                            <div class="col-md-2">
                                <div class="custom-control custom-switch form-switch form-switch-lg text-center">
                                    <input type="hidden" id="zone_frost_enable_hidden" value="" name="SETTINGS$zone_frost_enable">
                                    <input type="checkbox" class="form-check-input" id="zone_frost_enable" aria-describedby="zone_frost_enable">
                                    <span class="custom-control-label"></span>
                                </div>
                            </div>
                        </div>
                        <div id="zone_frost_settings" class="mt-3">
                            <div class="row align-items-center mb-2">
                                <div class="col">
                                    <strong class="mb-0" data-i18n="set.zone_frost_temp">{{ _('Poniżej jakiej temperatury') }}</strong>
                                </div>
                                <div class="col-md-2">
                                    <input type="number" class="form-control" id="zone_frost_temp" name="SETTINGS$zone_frost_temp" step="0.1" value="">
                                </div>
                            </div>
                            <div class="row align-items-center">
                                <div class="col">
                                    <strong class="mb-0" data-i18n="set.zone_frost_mode">{{ _('Tryb pracy w strefie mrozu') }}</strong>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select" aria-label="zone_frost_mode" id="zone_frost_mode" name="SETTINGS$zone_frost_mode" value="">
                                        <option value="turbo">Turbo</option>
                                        <option value="eco">Eco</option>
                                        <option value="quiet">Quiet</option>
                                        <option value="quiet_flimit">Quiet + FLimit</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col">
                                <strong class="mb-0" data-i18n="set.zone_warm">{{ _('Strefa dodatnia') }}</strong>
                                <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true" data-i18n="[data-bs-title]set.zone_warmtooltip" data-bs-title="."></i></div>
                            <div class="col-md-2">
                                <div class="custom-control custom-switch form-switch form-switch-lg text-center">
                                    <input type="hidden" id="zone_warm_enable_hidden" value="" name="SETTINGS$zone_warm_enable">
                                    <input type="checkbox" class="form-check-input" id="zone_warm_enable" aria-describedby="zone_warm_enable">
                                    <span class="custom-control-label"></span>
                                </div>
                            </div>
                        </div>
                        <div id="zone_warm_settings" class="mt-3">
                            <div class="row align-items-center mb-2">
                                <div class="col">
                                    <strong class="mb-0" data-i18n="set.zone_warm_temp">{{ _('Powyżej jakiej temperatury') }}</strong>
                                </div>
                                <div class="col-md-2">
                                    <input type="number" class="form-control" id="zone_warm_temp" name="SETTINGS$zone_warm_temp" step="0.1" value="">
                                </div>
                            </div>
                            <div class="row align-items-center">
                                <div class="col">
                                    <strong class="mb-0" data-i18n="set.zone_warm_mode">{{ _('Tryb pracy w strefie dodatniej') }}</strong>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select" aria-label="zone_warm_mode" id="zone_warm_mode" name="SETTINGS$zone_warm_mode" value="">
                                        <option value="turbo">Turbo</option>
                                        <option value="eco">Eco</option>
                                        <option value="quiet" data-i18n="set.zone_warm_mode_quiet">{{ _('Quiet') }}</option>
                                        <option value="quiet_flimit" data-i18n="set.zone_warm_mode_quietflimit">{{ _('Quiet + FLimit') }}</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

		                        </div>

<div class="list-group mb-4 shadow">
<div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col">
				    <strong class="mb-0" data-i18n="set.chscheduler">{{ _('Używaj harmonogramu dla C.O') }}</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.chschedulertooltip" data-bs-title="."></i>
                            </div>
                            <div class="col-md-2">
                                <div class="custom-control custom-switch form-switch form-switch-lg text-center">
					<input type="hidden" id="chscheduler_hidden" value="" name="SETTINGS$chscheduler">
                                          <input type="checkbox" class="form-check-input" id="chscheduler" aria-describedby="chscheduler">
                                    <span class="custom-control-label"></span>
                                </div>
                            </div>
                        </div>
                    </div>
		    <!--<button type="submit" class="btn btn-primary" data-i18n="set.btn.save">{{ _('Zapisz ustawienia') }}</button>-->
                                        </div>

                </div>
                <div class="tab-pane fade" id="settings-ha-tab" role="tabpanel" aria-labelledby="settings-ha-tab">
                  <div class="list-group mb-5 shadow">
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col">
				    <strong class="mb-0" data-i18n="set.haaddr">{{ _('Adres Home Assistant') }}</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.haaddrtooltip" data-bs-title="."></i>
                            </div>
			    <div class="col-md-2">
                                <div class="custom-control custom-switch">
		    <input type="text" class="form-control" id="haaddr" name="HOMEASSISTANT$HAADDR" aria-describedby="haaddr" value="">
                                    <span class="custom-control-label"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                <div class="list-group-item">
                    <div class="row align-items-center">
                        <div class="col">
				<strong class="mb-0" data-i18n="set.haport">{{ _('Port Home Assistant') }}</strong>
				<i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.haporttooltip" data-bs-title="."></i>
                        </div>
                        <div class="col-md-2">
                            <div class="custom-control custom-switch">
                    <input type="text" class="form-control" id="haport" name="HOMEASSISTANT$HAPORT" aria-describedby="haport" value="">
                                <span class="custom-control-label"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="list-group-item">
                    <div class="row align-items-center">
                        <div class="col">
				<strong class="mb-0" data-i18n="set.haapikey">{{ _('Klucz API Home Assistant') }}</strong>
				<i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.haapikeytooltip" data-bs-title="."></i>
                        </div>
                        <div class="col-md-2">
                            <div class="custom-control custom-switch">
                    <input type="password" class="form-control" id="hakey" name="HOMEASSISTANT$KEY" aria-describedby="hakey" value="">
                                <span class="custom-control-label"></span>
                            </div>
                        </div>
                    </div>
                </div>
		<div class="list-group-item">
                    <div class="row align-items-center">
                        <div class="col">
                            <strong class="mb-0" data-i18n="set.mqttdiscovery">{{ _('Używaj "MQTT Discovery"') }}</strong>
			    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.mqttdiscoverytooltip" data-bs-title="."></i>
                        </div>
                        <div class="col-md-2">
                            <div class="custom-control custom-switch form-switch form-switch-lg text-center">
                                <input type="hidden" id="ha_mqtt_discovery_hidden" value="" name="HOMEASSISTANT$ha_mqtt_discovery">
                                <input type="checkbox" class="form-check-input" id="ha_mqtt_discovery" value="1" {%if ha_mqtt_discovery == '1' %} checked {% endif %}>
                                <span class="custom-control-label"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="list-group-item">
                    <div class="row align-items-center">
                        <div class="col">
				<strong class="mb-0" data-i18n="set.itentity">{{ _('Encja temperatury wewnętrznej') }}</strong>
				<i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.itentitytooltip" data-bs-title="."></i>
                        </div>
                        <div class="col-md-2">
                            <div class="custom-control custom-switch">
                                    <input type="text" class="form-control" id="insidesensor" name="HOMEASSISTANT$insidesensor" aria-describedby="insidesensor" value="">
                                <span class="custom-control-label"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="list-group-item">
                    <div class="row align-items-center">
                        <div class="col">
				<strong class="mb-0" data-i18n="set.otentity">{{ _('Encja temperatury zewnętrznej') }}</strong>
				<i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.otentitytooltip" data-bs-title="."></i>
                        </div>
                        <div class="col-md-2">
                            <div class="custom-control custom-switch">
                                    <input type="text" class="form-control" id="outsidesensor" name="HOMEASSISTANT$outsidesensor" aria-describedby="outsidesensor" value="">
                                <span class="custom-control-label"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="list-group-item">
                    <div class="row align-items-center">
                        <div class="col">
				<strong class="mb-0" data-i18n="set.ihentity">{{ _('Encja czujnika wilgotności') }}</strong>
				<i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.ihentitytooltip" data-bs-title="."></i>
                        </div>
                        <div class="col-md-2">
                            <div class="custom-control custom-switch">
                                    <input type="text" class="form-control" id="humiditysensor" name="HOMEASSISTANT$humiditysensor" aria-describedby="humiditysensor" value="">
                                <span class="custom-control-label"></span>
                            </div>
                        </div>
                    </div>
				</div><!--<button type="submit" class="btn btn-primary" data-i18n="set.btn.save">{{ _('Zapisz ustawienia dla HA') }}</button>-->
				<div class="list-group-item">
				<div class="row align-items-center">
					<div class="col">
						<strong class="mb-0" data-i18n="set.dhwentity">DHW temperature entity</strong>
						<i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"
						data-bs-html="true"
						data-i18n="[data-bs-title]set.dhwentitytooltip"
						data-bs-title="Enter the Home Assistant entity ID used to read DHW temperature.">
						</i>
				</div>
        <div class="col-md-2">
            <div class="custom-control custom-switch">
                <input type="text" class="form-control" id="dhwsensor" name="HOMEASSISTANT$dhwsensor" aria-describedby="dhwsensor" value="">
                <span class="custom-control-label"></span>
            </div>
        </div>
    </div>
</div>

            </div>
              </div>
                <div class="tab-pane fade" id="settings-mqtt-tab" role="tabpanel" aria-labelledby="settings-mqtt-tab">
                    <div class="list-group mb-5 shadow">
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col">
				    <strong class="mb-0" data-i18n="set.mqtt">{{ _('Protokół MQTT') }}</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.mqtttooltip" data-bs-title="."></i>
                            </div>
                            <div class="col-md-2">
				    <div class="custom-control custom-switch">
						    <input type="hidden" id="use_mqtt_hidden" value="" name="MQTT$mqtt">
					  <input type="checkbox" class="form-check-input" id="use_mqtt" value="1" {%if use_mqtt == '1' %} checked {% endif %}>
                                    <span class="custom-control-label"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col">
				    <strong class="mb-0" data-i18n="set.mqttaddr">{{ _('Adres MQTT') }}</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.mqttaddrtooltip" data-bs-title="."></i>
                            </div>
                            <div class="col-md-2">
                                <div class="curol custom-switch">
                                    <input type="text" class="form-control" id="mqtt_broker_addr" name="MQTT$address" aria-describedby="mqtt_broker_addr" value="">
                                    <span class="custom-control-label"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col">
				    <strong class="mb-0" data-i18n="set.mqttport">{{ _('Port MQTT') }}</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.datamqttporttooltip" data-bs-title="."></i>
                            </div>
                            <div class="col-md-2">
                                <div class="custom-control custom-switch">
                                    <input type="text" class="form-control" id="mqtt_broker_port" name="MQTT$port" aria-describedby="mqtt_broker_port" value="">
                                    <span class="custom-control-label"></span>
                                </div>
                            </div>
                        </div>
                    </div>
		 <div class="list-group-item">
                    <div class="row align-items-center">
                        <div class="col">
                            <strong class="mb-0" data-i18n="set.mqtttls">{{ _('Używaj MQTT z TLS') }}</strong>
			    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.mqtttlstooltip" data-bs-title="."></i>
                        </div>
                        <div class="col-md-2">
                            <div class="custom-control custom-switch form-switch form-switch-lg text-center">
                                <input type="hidden" id="mqtt_ssl" value="" name="MQTT$mqtt_ssl">
                                <input type="checkbox" class="form-check-input" id="mqtt_mqtt_ssl" value="1" aria-describedby="mqtt_mqtt_ssl">
                                <span class="custom-control-label"></span>
                            </div>
                        </div>
                    </div>
                </div>
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col">
				    <strong class="mb-0" data-i18n="set.mqtttopic">{{ _('Główny topic MQTT') }}</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.mqtttopictooltip" data-bs-title="."></i>
                            </div>
                            <div class="col-md-2">
                                <div class="custom-control custom-switch">
                                        <input type="text" class="form-control" id="mqtt_topic" name="MQTT$main_topic" aria-describedby="mqtt_topic" value="">
                                    <span class="custom-control-label"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col">
				    <strong class="mb-0" data-i18n="set.mqttuser">{{ _('Nazwa użytkownika') }}</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.mqttusertooltip" data-bs-title="."></i>
                            </div>
                            <div class="col-md-2">
                                <div class="custom-control custom-switch">
                                        <input type="text" class="form-control" id="mqtt_username" name="MQTT$username" aria-describedby="mqtt_username" value="">
                                    <span class="custom-control-label"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col">
				    <strong class="mb-0" data-i18n="set.mqttpass">{{ _('Hasło użytkownika') }}</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.mqttpasstooltip" data-bs-title="."></i>
                            </div>
                                <div class="col-md-2">
                                    <div class="custom-control custom-switch">
                                        <input type="password" class="form-control" id="mqtt_password" name="MQTT$password" aria-describedby="mqtt_password" value="">
                                        <span class="custom-control-label"></span>
                                    </div>
                                </div>
                            </div>
		    </div><!--<button type="submit" class="btn btn-primary" data-i18n="set.btn.save">{{ _('Zapisz ustawienia MQTT') }}</button>-->
		    </div>
                </div>

<div class="tab-pane fade" id="settings-hpiapp-tab" role="tabpanel" aria-labelledby="settings-hpiapp-tab">
    <div class="list-group mb-5 shadow">
        <div class="list-group-item">
            <div class="row align-items-center">
                <div class="col">
                    <strong class="mb-0" data-i18n="set.hpikey">Application Key</strong>
                    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.hpikeytooltip" data-bs-title="."></i>
                </div>
                <div class="col-md-2">
                    <div class="custom-control custom-switch">
                        <input type="password" class="form-control" id="hpikey" name="HPIAPP$hpikey" aria-describedby="hpikey" value="">
                        <span class="custom-control-label"></span>
                    </div>
                </div>
            </div>
        </div>
	<div class="list-group-item">
            <div class="row align-items-center">
                <div class="col">
                        <strong class="mb-0" data-i18n="set.hpiconstart">Connect at startup</strong>
                    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.hpicontroltooltip" data-bs-title="."></i>
                </div>
                <div class="col-md-2">
                    <div class="custom-control custom-switch form-switch form-switch-lg text-center">
                        <input type="hidden" id="hpiatstart_hidden" value="" name="HPIAPP$hpiatstart">
                        <input type="checkbox" class="form-check-input" id="hpiatstart" aria-describedby="hpiatstart">
                        <span class="custom-control-label"></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="list-group-item">
            <div class="row align-items-center">
                <div class="col">
                    <strong class="mb-0" data-i18n="set.hpistatus">Connection status</strong>
                    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.hpistatustooltip" data-bs-title="."></i>
                </div>
                <div class="col-md-2">
                    <div class="custom-control custom-switch">
			    <h3 id='hpistatus' data-i18n="set.hpiconnected">Connected</h3>
                        <span class="custom-control-label"></span>
                    </div>
                </div>
            </div>                 
        </div>
        <div class="list-group-item">
            <div class="row align-items-center">
                <div class="col">
                    <strong class="mb-0" data-i18n="set.hpiconnsid">Connection session ID</strong>
                    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.hpiconnsidtooltip" data-bs-title="."></i>
                </div>
                <div class="col-md-2">
                    <div class="custom-control custom-switch">
                            <i id='hpisid'>xxx</i>
                        <span class="custom-control-label"></span>
                    </div>
                </div>
            </div>
        </div>
        <div class="list-group-item">
            <div class="row align-items-center">
                <div class="col">
			<strong class="mb-0" data-i18n="set.hpicontrol">Control</strong>
                    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.hpicontroltooltip" data-bs-title="."></i>
                </div>
                <div class="col-md-2">
                    <div class="custom-control custom-switch">
			    <button class="btn w-100" id='hpicontrol' data-i18n="set.hpidisconnect">Disconnect</button>
                        <span class="custom-control-label"></span>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

                <div class="tab-pane fade" id="settings-system-tab" role="tabpanel" aria-labelledby="settings-system-tab">
                <div class="list-group mb-5 shadow">
                    <div class="list-group-item">
                        <div class="row align-items-center">
				<div class="col">
						<strong class="mb-0" data-i18n="set.bindaddr">{{ _('Bind address') }}</strong>
						<i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.bindaddrtooltip" data-bs-title="."></i>
                            </div>
                            <div class="col-md-2">
                                <div class="custom-control custom-switch">
                                    <input type="text" class="form-control" id="bindaddr" name="MAIN$bindaddress" aria-describedby="bindaddr" value="">
                                    <span class="custom-control-label"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col">
				    <strong class="mb-0" data-i18n="set.bindport">{{ _('Bind port') }}</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.bindporttooltip" data-bs-title="."></i>
                            </div>
                            <div class="col-md-2">
                                <div class="custom-control custom-switch">
                                    <input type="text" class="form-control" id="bindport" name="MAIN$bindport" aria-describedby="bindport" value="">
                                    <span class="custom-control-label"></span>
                                </div>
                            </div>
                        </div>                 </div>
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col">
				    <strong class="mb-0" data-i18n="set.serial">{{ _('Serial port') }}</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.serialtooltip" data-bs-title="."></i>
                            </div>
                            <div class="col-md-2">
                                <div class="custom-control custom-switch">
                                    <input type="text" class="form-control" id="modbusdev" name="MAIN$modbusdev" aria-describedby="modbusdev" value="">
                                    <span class="custom-control-label"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col">
				    <strong class="mb-0" data-i18n="set.modbusgpio">{{ _('Modbus GPIO') }}</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.modbusgpiotooltip" data-bs-title="."></i>
                            </div>
                            <div class="col-md-2">
                                <div class="custom-control custom-switch">
                                        <input type="text" class="form-control" id="modbuspin" name="GPIO$modbus" aria-describedby="modbuspin" value="">
                                    <span class="custom-control-label"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col">
				    <strong class="mb-0" data-i18n="set.flgpio">{{ _('Frequency limit GPIO') }}</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.flgpiotooltip" data-bs-title="."></i>
                            </div>
                            <div class="col-md-2">
                                <div class="custom-control custom-switch">
                                        <input type="text" class="form-control" id="freqlimitpin" name="GPIO$freqlimit" aria-describedby="freqlimitpin" value="">
                                    <span class="custom-control-label"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col">
				    <strong class="mb-0" data-i18n="set.hdgpio">{{ _('Heat demand GPIO') }}</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.hdgpiotooltip" data-bs-title="."></i>
                            </div>
                                <div class="col-md-2">
                                    <div class="custom-control custom-switch">
                                        <input type="text" class="form-control" id="heatdemandpin" name="GPIO$heatdemand" aria-describedby="heatdemandpin" value="">
                                        <span class="custom-control-label"></span>
                                    </div>
                                </div>
                            </div>
                    </div>
                    <div class="list-group-item">
                     <div class="row align-items-center">
                            <div class="col">
				    <strong class="mb-0" data-i18n="set.cdgpio">{{ _('Cool demand GPIO') }}</strong>
				    <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom"  data-bs-html="true" data-i18n="[data-bs-title]set.cdgpiotooltip" data-bs-title="."></i>
                            </div>
                                <div class="col-md-2">
                                    <div class="custom-control custom-switch">
                                        <input type="text" class="form-control" id="cooldemandpin" name="GPIO$cooldemand" aria-describedby="cooldemandpin" value="">
                                        <span class="custom-control-label"></span>
                                    </div>
                                </div>
			    </div>
			</div>
	                    <div class="list-group-item">
	                        <div class="row align-items-center">
	                            <div class="col">
	                                <strong class="mb-0" data-i18n="set.system_datetime">System date &amp; time</strong>
	                                <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true"
	                                   data-i18n="[data-bs-title]set.system_datetime_tooltip"
	                                   data-bs-title="Current date and time from the controller (DietPi)."></i>
	                            </div>
	                            <div class="col-md-2">
	                                <input type="text" id="system_datetime_value" class="form-control form-control-sm text-center system-datetime-input" readonly value="">
	                            </div>
	                        </div>
	                    </div>

	                    <div class="list-group-item">
	                        <div class="row align-items-center">
	                            <div class="col">
	                                <strong class="mb-0" data-i18n="set.loglevel">{{ _('Log level') }}</strong>
	                                <i class="bi bi-info-circle ms-2 text-accent3" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true"
	                                   data-i18n="[data-bs-title]set.logleveltooltip"
	                                   data-bs-title="Logging verbosity for HaierPi (DEBUG, INFO, WARNING, ERROR)."></i>
	                            </div>
	                            <div class="col-md-2">
	                                <select class="form-select form-select-sm text-center" id="log_level" name="MAIN$log_level" aria-describedby="log_level">
	                                    <option value="DEBUG">DEBUG</option>
	                                    <option value="INFO" selected>INFO</option>
	                                    <option value="WARNING">WARNING</option>
	                                    <option value="ERROR">ERROR</option>
	                                </select>
	                            </div>
	                        </div>
	                    </div>
			</div><!--<button type="submit" class="btn btn-primary" data-i18n="set.btn.save">{{ _('Save') }}</button>-->
                    </div>
                </div>
<!--                <div class="tab-pane fade" id="settings-logs-tab" role="tabpanel" aria-labelledby="settings-logs-tab">
                    <div class="list-group mb-5 sha                    <div class="list-group-item">
                        <div class="row align-items-center" id="journal">

			</div>
                        <script>
        var journalDiv = document.getElementById('journal');
				var eventSource = new EventSource(window.location.origin+":5000/stream");

        eventSource.onmessage = function(event) {
            var line = document.createElement('p');
            line.className = 'journal-entry';
            line.innerHTML = event.data;
            journalDiv.appendChild(line);

            setTimeout(function() {
                line.classList.add('fadeout');
            }, 2000);
        };
    </script>

			    </div><div class="btn-group" role="group"><button id="startlogbutton" onclick="start_log('restart');" class="btn btn-outline-primary">{{ _('Start logging') }}</button><button onclick="download_log();" class="btn btn-outline-primary">{{ _('Save to file') }}</button> </div>
                    </div>
</div>

	    </div>-->
                <div class="tab-pane fade" id="settings-service-tab" role="tabpanel" aria-labelledby="settings-service-tab">

<div class="list-group mb-4 shadow">

    <div class="list-group-item">
        <div class="row align-items-center">
            <div class="col">
                <strong class="mb-0" data-i18n="set.tempcomp">Kompensacja temperatury</strong>
                <i class="bi bi-info-circle ms-2 text-accent3"
                   data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true"
                   data-i18n="[data-bs-title]set.tempcomptooltip"
                   data-bs-title="Temperature compensation (A03). You can read current value and set it in range -15…15 by 0.5"></i>
            </div>
            <div class="col-md-2">
                <div class="input-group">
                    <button class="btn btn-outline-secondary" type="button" id="tempcomp_minus">-</button>
                    <input type="text" class="form-control form-control-sm text-center" id="tempcompensation_set" value="0.0" readonly>
                    <button class="btn btn-outline-secondary" type="button" id="tempcomp_plus">+</button>
                </div>
            </div>
        </div>
    </div>

</div>

<div class="list-group mb-4 shadow">

    <div class="list-group-item">
        <div class="row align-items-center">
            <div class="col">
                <strong class="mb-0" data-i18n="set.error">Error - Aktywny błąd jednostki</strong>
            </div>
            <div class="col-md-2">
                <input type="text" class="form-control form-control-sm text-center" id="service_error" value="N.A" readonly>
            </div>
        </div>
    </div>

    <div class="list-group-item">
        <div class="row align-items-center">
            <div class="col">
                <strong class="mb-0" data-i18n="set.lasterror">LastError - Potwierdzony błąd jednostki</strong>
            </div>
            <div class="col-md-2">
                <input type="text" class="form-control form-control-sm text-center" id="service_lasterror" value="N.A" readonly>
            </div>
        </div>
    </div>

    <div class="list-group-item">
        <div class="row align-items-center">
            <div class="col">
                <strong class="mb-0" data-i18n="set.archerror">Archerror - Ostatnio zapisane błędy</strong>
            </div>
            <div class="col-md-2">
                <input type="text" class="form-control form-control-sm text-center" id="service_archerror" value="N.A" readonly>
            </div>
        </div>
    </div>
</div>

<div class="list-group mb-4 shadow">

    <div class="list-group-item">
        <div class="row align-items-center">
            <div class="col">
                <strong class="mb-0" data-i18n="set.firmware">Wersja oprogramowania</strong>
            </div>
            <div class="col-md-2">
                <input type="text" class="form-control form-control-sm text-center" id="service_firmware" value="N.A" readonly>
            </div>
        </div>
    </div>

</div>

                </div>

	</form>
            </div>
<div class="row align-items-center mb-4" id="saveRow"><div class="col"><button class="btn btn-outline-secondary w-100" id="saveButton" data-i18n="set.btn.save"></button></div></div>
        </div>
    </div>

</div>
	{% endblock %}
	{% block end_scripts %}

<!-- SETTINGS-ONLY: tooltip refresh after i18n (bez ruszania base/index) -->
<script>
(function () {
  function refreshTooltipsBs5(root) {
    if (!window.bootstrap || !bootstrap.Tooltip) return;
    root = root || document;
    root.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function (el) {
      try {
        var inst = bootstrap.Tooltip.getInstance(el);
        if (inst) inst.dispose();
        new bootstrap.Tooltip(el);
      } catch (e) {
        // nic
      }
    });
  }

  function run() {
    var root = document.getElementById('settingsForm') || document;
    refreshTooltipsBs5(root);
  }

  // 1) Po wczytaniu strony (i18next zwykle kończy init chwilę później)
  window.addEventListener('load', function () {
    setTimeout(run, 50);
    setTimeout(run, 400);
    setTimeout(run, 1200);
  });

  // 2) Po zmianie zakładki (tooltips w ukrytych tabach też mają się odświeżyć)
  document.addEventListener('shown.bs.tab', function () {
    setTimeout(run, 0);
  });

  // 3) Jeśli i18next jest dostępny, odśwież po init i po zmianie języka
  function attachI18nHooks() {
    if (!window.i18next || typeof i18next.on !== 'function') return false;
    i18next.on('initialized', function () { setTimeout(run, 0); });
    i18next.on('languageChanged', function () { setTimeout(run, 0); });
    return true;
  }

  if (!attachI18nHooks()) {
    // jeśli i18next ładuje się później, spróbuj przez chwilę dociągnąć hooki
    var tries = 0;
    var timer = setInterval(function () {
      tries += 1;
      if (attachI18nHooks() || tries > 100) clearInterval(timer); // ~5s
    }, 50);
  }
})();
</script>

<script>
// Funkcja do usuwania klas z danym prefiksem (zostawiłem, jest przydatna)
function removeClassesByPrefix(selector, prefix) {
    $(selector).removeClass(function(index, className) {
        return (className.match(new RegExp('\\b' + prefix + '\\S+', 'g')) || []).join(' ');
    });
}

// Prosty helper do tłumaczeń dynamicznych (statusy/przyciski)
function t(key, fallback) {
    try {
        if (window.i18next && typeof i18next.t === 'function') {
            const v = i18next.t(key);
            if (v && v !== key) return v;
        }
    } catch (e) {}
    return (fallback !== undefined) ? fallback : key;
}

// Całą logikę umieszczamy wewnątrz $(document).ready(), aby mieć pewność, że DOM jest załadowany.
$(document).ready(function() {

    // ########### LOGIKA UI (refaktoryzacja) ###########

    function updateAntiOnOffView() {
        const isChecked = $("#antionoff").is(":checked");
        // blok z ustawieniami delty aktywny tylko gdy Anty ON-OFF jest włączone
        $("#antionoffsettings").toggleClass("disableddiv", !isChecked);

        // parametry zależne od temperatury mają być wyszarzone, gdy Anty ON-OFF jest włączone
        $("#divflimittemp, #divpresetchange, #divpresetquiet, #divpresetturbo").toggleClass("disableddiv", isChecked);
    }



    // Sterowanie ogrzewaniem: Krzywa grzewcza vs Bezpośrednio

// --- Pamiętanie ostatniego typu krzywej (auto/static/manual) ---
const LAST_CURVE_LS_KEY = 'hpi_last_curve_type';
let lastCurveType = null;

function isValidCurveType(v) {
    return v === 'auto' || v === 'static' || v === 'manual';
}

function getCurveTypeFromConfigHidden() {
    const v = String($("#heatingcurve_hidden").val() || '').toLowerCase().trim();
    return isValidCurveType(v) ? v : null;
}

function loadLastCurveType() {
    // 1) pamięć runtime (np. po przełączeniach w tej sesji)
    if (isValidCurveType(lastCurveType)) return lastCurveType;

    // 2) localStorage (jeśli było wcześniej ustawione)
    try {
        const ls = String(localStorage.getItem(LAST_CURVE_LS_KEY) || '').toLowerCase().trim();
        if (isValidCurveType(ls)) return ls;
    } catch (e) {}

    // 3) ostatecznie
    return 'auto';
}

function saveLastCurveType(v) {
    if (!isValidCurveType(v)) return;
    lastCurveType = v;
    try { localStorage.setItem(LAST_CURVE_LS_KEY, v); } catch (e) {}
}
    function getEffectiveHeatingCurveMode() {
        const ctrl = $("#heatingcontrol").val();
        if (ctrl === 'direct') return 'directly';
        return $("#heatingcurve").val();
    }

    function applyHeatingCurveFromHidden() {
        const v = String($("#heatingcurve_hidden").val() || '').toLowerCase().trim();

        if (v === 'directly' || v === 'direct') {
            // Tryb Bezpośrednio: hidden trzyma "directly", ale typ krzywej ma pozostać ostatnio wybrany
            $("#heatingcontrol").val('direct');
            const remembered = loadLastCurveType();
            $("#heatingcurve").val(remembered);
        } else if (isValidCurveType(v)) {
            // Tryb Krzywa: hidden = auto/static/manual
            $("#heatingcontrol").val('curve');
            $("#heatingcurve").val(v);
            saveLastCurveType(v);
        } else {
            // Fallback
            $("#heatingcontrol").val('curve');
            const remembered = loadLastCurveType();
            $("#heatingcurve").val(remembered);
            saveLastCurveType(remembered);
        }
    }

    function syncHeatingCurveHidden() {
        const effective = getEffectiveHeatingCurveMode();
        $("#heatingcurve_hidden").val(effective);
    }

    function updateHeatingControlView() {
        const isDirect = $("#heatingcontrol").val() === 'direct';
        $("#heatingcurve_section").toggleClass('disableddiv', isDirect);
        // Direct mode options are only active when Heating control = Direct
        $("#directmode_section").toggleClass('disableddiv', !isDirect);
        syncHeatingCurveHidden();
    }

    function updateHeatingCurveView() {
        const selectedCurve = getEffectiveHeatingCurveMode();
        const divVisibility = {
            auto:     { slope: true,  pshift: true,  hcamp: true,  manual: false },
            static:   { slope: true,  pshift: false, hcamp: false, manual: false },
            manual:   { slope: false, pshift: false, hcamp: false, manual: true },
            directly: { slope: false, pshift: false, hcamp: false, manual: false }
        };

        const config = divVisibility[selectedCurve] || divVisibility.directly; // Domyślna wartość

        $("#divslope").toggleClass("disableddiv", !config.slope);
        $("#divpshift").toggleClass("disableddiv", !config.pshift);
        $("#divhcamp").toggleClass("disableddiv", !config.hcamp);
        $("#divhcmanual").toggleClass("disableddiv", !config.manual);
    }

    function updatePresetDependency() {
        const presetMode = $('[name="SETTINGS$presetautochange"]').val();
        const antionoffCheckbox = $('#antionoff');
        const antionoffContainer = antionoffCheckbox.closest('.list-group-item');

        if (presetMode === 'manual') {
            antionoffContainer.addClass('disableddiv');
            if (antionoffCheckbox.is(':checked')) {
                antionoffCheckbox.prop('checked', false).trigger('change');
            }
        } else {
            antionoffContainer.removeClass('disableddiv');
        }
    }
    
    
    function updateZoneViews() {
        const frostOn = $("#zone_frost_enable").is(":checked");
        $("#zone_frost_settings").toggleClass("disableddiv", !frostOn);

        const warmOn = $("#zone_warm_enable").is(":checked");
        $("#zone_warm_settings").toggleClass("disableddiv", !warmOn);
    }

        function updateDhwViews() {
        const DhwON = $("#dhwuse").is(":checked");
        $("#dhw_settings").toggleClass("disableddiv", !DhwON);

    }

    function updateDhwModeViews() {
        const DhwModeON = $("#dhwwl").is(":checked");
        $("#dhw_mode_settings").toggleClass("disableddiv", !DhwModeON);

    }

// NOWA FUNKCJA DLA ZALEŻNOŚCI HOME ASSISTANT
    function updateHaDependencies() {
        // Krok 1: Sprawdzenie ogólnej konfiguracji HA (Warunek Główny)
        const haAddr = $('[name="HOMEASSISTANT$HAADDR"]').val().trim();
        const haPort = $('[name="HOMEASSISTANT$HAPORT"]').val().trim();
        const haKey = $('[name="HOMEASSISTANT$KEY"]').val().trim();
        const isHaCoreConfigured = haAddr !== '' && haPort !== '' && haKey !== '';

        // Krok 2: Sprawdzenie każdego selecta z osobna
        
        // 2a. Czujnik temperatury wewnętrznej
        const insideSensorEntity = $('[name="HOMEASSISTANT$insidesensor"]').val().trim();
        const canUseHaForInsideTemp = isHaCoreConfigured && insideSensorEntity !== '';
        $('[name="SETTINGS$insidetemp"] option[value="ha"]').prop('disabled', !canUseHaForInsideTemp);

        // 2b. Czujnik temperatury zewnętrznej
        const outsideSensorEntity = $('[name="HOMEASSISTANT$outsidesensor"]').val().trim();
        const canUseHaForOutsideTemp = isHaCoreConfigured && outsideSensorEntity !== '';
        $('[name="SETTINGS$outsidetemp"] option[value="ha"]').prop('disabled', !canUseHaForOutsideTemp);

        // 2c. Czujnik wilgotności
        const humiditySensorEntity = $('[name="HOMEASSISTANT$humiditysensor"]').val().trim();
        const canUseHaForHumidity = isHaCoreConfigured && humiditySensorEntity !== '';
        $('[name="SETTINGS$humidity"] option[value="ha"]').prop('disabled', !canUseHaForHumidity);

        // 2d. Czujnik temperatury CWU (DHW)
        const dhwSensorEntity = $('[name="HOMEASSISTANT$dhwsensor"]').val().trim();
        const canUseHaForDhwTemp = isHaCoreConfigured && dhwSensorEntity !== '';
        const $dhwTempSelect = $('[name="SETTINGS$dhwtemp"]');
        $dhwTempSelect.find('option[value="ha"]').prop('disabled', !canUseHaForDhwTemp);
        // Jeżeli użytkownik miał wybrane HA, a brakuje encji / konfiguracji — wracamy do wbudowanego
        if (!canUseHaForDhwTemp && ($dhwTempSelect.val() || '').toLowerCase() === 'ha') {
            $dhwTempSelect.val('builtin');
        }
    }

    function assembleManualHeatingCurve() {
        const values = $("#hcmantable input[type='number']").map(function() {
            return $(this).val();
        }).get();
        $('#hcman').val(values.join(','));
    }
    
        // Init state from server-rendered hidden value
    applyHeatingCurveFromHidden();
    updateHeatingControlView();
    updateHeatingCurveView();

// ########### POWIĄZANIA ZDARZEŃ (unobtrusive JS) ###########

    // Zdarzenia dla checkboxów z ukrytym inputem
    // To jest ogólna obsługa, która zadziała dla każdego checkboxa, który ma tuż przed sobą ukryty input
    $('input[type="checkbox"]').on('change', function() {
        const hiddenInput = $(this).prev('input[type="hidden"]');
        if (hiddenInput.length) {
            hiddenInput.val($(this).is(':checked') ? '1' : '0');
        }
    });

    // Powiązania dla specyficznych kontrolek UI
    $("#antionoff").on('change', updateAntiOnOffView);
    $("#heatingcontrol").on('change', function(){
        const isDirect = $("#heatingcontrol").val() === 'direct';

        if (isDirect) {
            // przechodzimy na Bezpośrednio: zapamiętaj ostatni typ krzywej
            const cur = String($("#heatingcurve").val() || '').toLowerCase().trim();
            if (isValidCurveType(cur)) saveLastCurveType(cur);
        } else {
            // wracamy na Krzywą: przywróć ostatnio wybrany typ (z configu lub pamięci)
            const fromConfig = getCurveTypeFromConfigHidden();
            const remembered = fromConfig || loadLastCurveType();
            $("#heatingcurve").val(remembered);
            saveLastCurveType(remembered);
        }

        updateHeatingControlView();
        updateHeatingCurveView();
    });
    $("#heatingcurve").on('change', function(){
        const cur = String($("#heatingcurve").val() || '').toLowerCase().trim();
        if (isValidCurveType(cur)) saveLastCurveType(cur);
        syncHeatingCurveHidden();
        updateHeatingCurveView();
    });
    $("#zone_frost_enable, #zone_warm_enable").on('change', updateZoneViews);
    $("#dhwwl").on('change', updateDhwModeViews);
    $("#dhwuse").on('change', updateDhwViews);
    $("#hcmantable input[type='number']").on('change', assembleManualHeatingCurve);
    
    // Zdarzenia dla wykresu
    $("#tempRange, #slope, #pshift, #hcamp").on('input change', recalc);
    $('[name="SETTINGS$presetautochange"]').on('change', function() {
    const selectedMode = $(this).val();
    const antionoffCheckbox = $('#antionoff');

    // Sprawdzamy, czy użytkownik włącza tryb 'manual', a opcja 'antionoff' jest aktywna
    if (selectedMode === 'manual' && antionoffCheckbox.is(':checked')) {
        // Wyświetlamy ostrzeżenie
        appendAlert('Opcja "Anty ON-OFF" zostanie wyłączona, ponieważ jest niekompatybilna z ręczną zmianą trybu.', 'warning');
    }
    
    // Niezależnie od alertu, zawsze aktualizujemy stan UI
    updatePresetDependency();
    });

    $('[name^="HOMEASSISTANT$"]').on('input', updateHaDependencies);
 

    // ########### LOGIKA WEBSOCKET ###########
    
    const socket = io();

    socket.on('settings', function(data) {
        console.log("Otrzymano ustawienia:", data);
        
        // Wypełnianie formularza
        for (let key in data) {
            const element = $(`[name="${key}"]`);
            if (!element.length) continue;

            // Obsługa checkboxów
            if (element.attr('type') === 'hidden' && element.next().attr('type') === 'checkbox') {
                const isChecked = parseInt(data[key]) === 1;
                element.val(isChecked ? '1' : '0');
                element.next().prop('checked', isChecked);
            } 
            // Obsługa ręcznej krzywej
            else if (key === 'SETTINGS$hcman' && Array.isArray(data[key])) {
                element.val(data[key].join(','));
                const hcmanValues = data[key];
                $("#hcmantable input[type='number']").each(function(index) {
                    if (index < hcmanValues.length) {
                        $(this).val(hcmanValues[index]);
                    }
                });
            }
            // Pozostałe pola (text, select, number)
            else {
                element.val(data[key]);
            }
        }
        
        // --- KLUCZOWA CZĘŚĆ ---
        // Po wypełnieniu wszystkich pól, ręcznie wywołujemy funkcje aktualizujące UI
        console.log("Aktualizowanie widoku UI po załadowaniu danych...");
        applyHeatingCurveFromHidden();
        updateHeatingControlView();
        updateAntiOnOffView();
        updateHeatingCurveView();
	updatePresetDependency();
	updateHaDependencies();
	updateZoneViews();
    updateDhwModeViews();
    updateDhwViews();
        recalc(); // Aby wykres odświeżył się z załadowanymi danymi

        // Logika dla statusu połączenia HPI (pozostawiona bez zmian)
        if ('hpiconn' in data) {
	switch (data['hpiconn']) {
    case 'N.A.': {
        const unk = t('set.hpiunknown', 'Unknown');
        $('#hpistatus').text(unk);
        $('#hpistatus')[0].classList.add('text-warning');
        $('#hpisid').text(unk);
        $("#hpicontrol")[0].classList.add('btn-outline-warning');
        $("#hpicontrol")[0].classList.add('disabled');
        $("#hpicontrol").text(unk);
        break;
    }
    case null: {
        const disconnected = t('set.hpidisconnected', 'Disconnected');
        const unk = t('set.hpiunknown', 'Unknown');
        const connect = t('set.hpiconnect', 'Connect');
        removeClassesByPrefix('#hpistatus', 'text-');
        removeClassesByPrefix('#hpicontrol', 'btn-outline-');
        $('#hpistatus').text(disconnected);
        $('#hpistatus')[0].classList.add('text-danger');
        $('#hpisid').text(unk);
        $("#hpicontrol")[0].classList.remove('disabled');
        $("#hpicontrol")[0].classList.add('btn-outline-success');
        $("#hpicontrol").text(connect);
        break;
    }
    case false: {
        const disconnected = t('set.hpidisconnected', 'Disconnected');
        const unk = t('set.hpiunknown', 'Unknown');
        const connect = t('set.hpiconnect', 'Connect');
        removeClassesByPrefix('#hpistatus', 'text-');
        removeClassesByPrefix('#hpicontrol', 'btn-outline-');
        $('#hpistatus').text(disconnected);
        $('#hpistatus')[0].classList.add('text-danger');
        $('#hpisid').text(unk);
        $("#hpicontrol")[0].classList.remove('disabled');
        $("#hpicontrol")[0].classList.add('btn-outline-success');
        $("#hpicontrol").text(connect);
        $("#hpicontrol")[0].classList.add('disabled');
        break;
    }
    default: {
        const connected = t('set.hpiconnected', 'Connected');
        const disconnect = t('set.hpidisconnect', 'Disconnect');
        removeClassesByPrefix('#hpistatus', 'text-');
        removeClassesByPrefix('#hpicontrol', 'btn-outline-');
        $('#hpistatus').text(connected);
        $('#hpisid').text(data['hpiconn']);
        $('#hpistatus')[0].classList.add('text-success');
        $("#hpicontrol")[0].classList.remove('disabled');
        $("#hpicontrol")[0].classList.add('btn-outline-danger');
        $("#hpicontrol").text(disconnect);
    }
}
        }
    });

    socket.on('return', function(msg) {
        if (msg.info && msg.status) {
            appendAlert(msg.info, msg.status);
        }
        console.log("Odpowiedź z serwera:", msg);
    });

    // Przycisk zapisu
    $("#saveButton").on("click", function(event) {
        event.preventDefault();
        if (!socket.connected) {
            console.warn("Socket nie jest połączony!");
            appendAlert("Brak połączenia z serwerem!", "danger");
            return;
        }

        let formData = { settings: {} };
        $("#settingsForm").find("select, input").each(function() {
            if (this.name) {
                formData.settings[this.name] = $(this).val();
            }
        });
        
        isFormDirty = false; // Resetujemy flagę po wysłaniu
        socket.emit("client", formData);
        console.log("Wysłano ustawienia:", formData);
    });
    
    // Logika HPI App (pozostawiona bez zmian)
    $('#hpicontrol').click(function () {
        const command = $(this).text().toLowerCase();
        socket.emit('client', { hpiapp: command });
    });

    // ########### SERVICE TAB (Temp compensation + errors) ###########
    function svcToNumber(v) {
        if (v === null || v === undefined) return null;
        const s = String(v).trim().replace("°C", "").replace(",", ".");
        if (!s || s.toUpperCase() === "N.A" || s.toLowerCase() === "nan") return null;
        const n = Number(s);
        return Number.isFinite(n) ? n : null;
    }

    // Show as delta vs 0.0, with sign for non-zero values
    function svcFmtDelta(v) {
        const n = svcToNumber(v);
        if (n === null) return "0.0";
        const r = Math.round(n * 2) / 2; // keep 0.5 steps in UI
        const s = r.toFixed(1);
        if (Math.abs(r) < 0.05) return "0.0";
        return (r > 0 ? "+" : "") + s;
    }
    function svcFmtPlain(v) {
        if (v === null || v === undefined) return "N.A";
        const s = String(v).trim();
        if (!s || s.toUpperCase() === "N.A" || s.toLowerCase() === "nan") return "N.A";
        return s;
    }

    function loadServiceData() {
        // Only run if Service tab exists on this page
        if (!$("#settings-service-tab").length) return;

        $.getJSON("/getdata", function(d) {
            // Temperature compensation
            // Prefer actual readback if available, otherwise fall back to last set value.
            const curN = svcToNumber(d.tempcompensation);
            const setN = svcToNumber(d.tempcompensation_set);
            const display = (curN !== null) ? curN : ((setN !== null) ? setN : 0.0);

            $("#tempcompensation_set").val(svcFmtDelta(display));

            // Errors + info
            $("#service_error").val(svcFmtPlain(d.error));
            $("#service_lasterror").val(svcFmtPlain(d.lasterror));
            $("#service_archerror").val(svcFmtPlain(d.archerror));
            $("#service_firmware").val(svcFmtPlain(d.firmware));
        });
    }

    function getTempCompSetNumeric() {
        const n = svcToNumber($("#tempcompensation_set").val());
        return (n === null) ? 0.0 : n;
    }

    function setTempCompensation(value) {
        // Clamp and round to 0.5
        let v = Number(value);
        if (!Number.isFinite(v)) v = 0.0;
        v = Math.max(-15.0, Math.min(15.0, v));
        v = Math.round(v * 2) / 2;

        // UI: optimistic update (delta formatting)
        $("#tempcompensation_set").val(svcFmtDelta(v));
        // If readback is not instant, keep current in sync for better UX
        // Send to backend
        $("#tempcomp_minus, #tempcomp_plus").prop("disabled", true);
        $.ajax({
            url: "/tempcompchange",
            method: "POST",
            data: { value: v.toFixed(1) }
        }).done(function(resp) {
            if (resp && resp.msg && resp.state) {
                appendAlert(resp.msg, resp.state);
            }
            // Refresh readback shortly after write
            setTimeout(loadServiceData, 400);
        }).fail(function() {
            appendAlert("Temp compensation: request failed", "danger");
            loadServiceData();
        }).always(function() {
            $("#tempcomp_minus, #tempcomp_plus").prop("disabled", false);
        });
    }

    // Buttons + / -
    $("#tempcomp_minus").on("click", function() {
        const v = getTempCompSetNumeric() - 0.5;
        setTempCompensation(v);
    });
    $("#tempcomp_plus").on("click", function() {
        const v = getTempCompSetNumeric() + 0.5;
        setTempCompensation(v);
    });

    // Initial + periodic refresh (lightweight)
    loadServiceData();
    setInterval(loadServiceData, 5000);

// Hide global "Save" button on Service tab (not needed there) + adjust padding on mobile
function toggleSaveButtonForTab(tabId) {
    const $row = $("#saveRow");
    const $content = $("#ex1-content");
    if (!$row.length) return;

    const isService = (tabId === "settings-service");
    $row.toggleClass('d-none', isService);

    // On mobile: if Save bar is hidden, remove extra bottom padding (no empty scroll)
    if ($content.length) {
        $content.toggleClass('no-save-padding', isService);
    }
}

// Refresh when user opens a tab
document.addEventListener('shown.bs.tab', function (e) {
    try {
        if (e && e.target && e.target.id) {
            toggleSaveButtonForTab(e.target.id);
            if (e.target.id === "settings-service") {
                loadServiceData();
            }
        }
        // On mobile, jump to top of page after switching tabs (prevents "blank space" confusion)
        if (window.matchMedia && window.matchMedia("(max-width: 576px)").matches) {
            window.scrollTo(0, 0);
        }
    } catch (err) {}
});

// Initial state
toggleSaveButtonForTab($(".nav-link.active").attr("id"));

});

// ########### LOGIKA WYKRESU (pozostawiona w większości bez zmian) ###########

var colors = ['#007bff','#28a745','#333333','#c3e6cb','#dc3545','#6c757d'];
var chLine = document.getElementById('hcurvechart');
var myChart; // Zmienna globalna dla wykresu

var chartData = {
    labels: Array.from({ length: 41 }, (_, i) => i - 20).map(String), // Lepszy sposób generowania etykiet
    datasets: [{
        label: "Auto",
        data: [],
        backgroundColor: 'transparent',
        borderColor: colors[0],
        borderWidth: 4,
        pointBackgroundColor: colors[0]
    }, {
        label: "Static",
        data: [],
        backgroundColor: 'transparent',
        borderColor: colors[1],
        borderWidth: 4,
        pointBackgroundColor: colors[1]
    }]
};

if (chLine) {
    myChart = new Chart(chLine, {
        type: 'line',
        data: chartData,
        options: { /* ... Twoje opcje ... */ }
    });
}

function recalc() {
    if (!myChart) return; // Zabezpieczenie, jeśli wykres nie istnieje
    
    const settemp = 22; // Powinno być pobierane z ustawień
    const insidetemp = parseFloat($("#tempRange").val()) || settemp;
    const outsidetemp = 11; // Powinno być pobierane z danych
    
    $("#customtemp").text("Temperatura wewnątrz: " + insidetemp);
    
    const slope = parseFloat($('#slope').val()) || 0;
    const ps = parseFloat($('#pshift').val()) || 0;
    const amp = parseFloat($('#hcamp').val()) || 0;

    const autoData = myChart.data.labels.map(element => {
        const outTemp = parseFloat(element);
        const t1 = (outsidetemp / (320 - (outsidetemp * 4)));
        const t2 = Math.pow(settemp, t1);
        return ((((0.55 * slope * t2) * (((-outTemp + 20) * 2) + settemp + ps) + ((settemp - insidetemp) * amp)) + ps) *2)/2;
    });
    
    const staticData = myChart.data.labels.map(element => {
        const outTemp = parseFloat(element);
        return (settemp + (slope * 20) * Math.pow(((settemp - outTemp) / 20), 0.7));
    });

    myChart.data.datasets[0].data = autoData;
    myChart.data.datasets[1].data = staticData;
    myChart.update();
}

// ########### LOGIKA NIEZAPISANYCH ZMIAN (pozostawiona bez zmian) ###########
let isFormDirty = false;
const modal = new bootstrap.Modal(document.getElementById("unsavedChangesModal"));
let pendingNavigation = null;

document.addEventListener("input", (event) => {
    if (event.target.matches("input, select, textarea")) {
        isFormDirty = true;
    }
});
document.querySelectorAll(".navl").forEach(link => {
    link.addEventListener("click", (event) => {
        if (isFormDirty) {
            event.preventDefault();
            pendingNavigation = event.target.href;
            modal.show();
        }
    });
});
document.getElementById("leavePageBtn").addEventListener("click", () => {
    if (pendingNavigation) {
        window.location.href = pendingNavigation;
    }
});

// --- System tab: show server (DietPi) date & time ---
function updateSystemDateTime() {
    const el = document.getElementById('system_datetime_value');
    if (!el) return;
    $.getJSON('/api/system_time')
        .done(function (data) {
            const val = (data && (data.display || data.iso)) ? (data.display || data.iso) : '';
            if ('value' in el) { el.value = val; } else { el.textContent = val; }
        })
        .fail(function () {
            // ignore
        });
}

// initial + refresh when switching tabs + periodic refresh
updateSystemDateTime();
setInterval(updateSystemDateTime, 30000);
document.addEventListener('shown.bs.tab', function (ev) {
    // refresh when System tab is shown
    if (ev && ev.target && (ev.target.id === 'settings-system' || ev.target.getAttribute('data-bs-target') === '#settings-system-tab')) {
        updateSystemDateTime();
    }
});

// Inicjalizacja tooltipów
const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

</script>
{% endblock %}